<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>e6-quickview</title>
</head>
    <style>
        html, body {
            width: 100vw;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            display: flex;
            background-color: black;
        }

        a {
            color: white;
        }

        #sidebar {
            width: 15%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        #history {
            display: flex;
            flex-direction: column;

            img, video {
                width: 100%;
            }
        }

        #media-view {
            width: 100%;
            height: 100%;

            img, video {
                width: 100%;
                height: 100%;
                object-fit: contain;
            }
        }
    </style>
    <script>
function logout() {
    localStorage.removeItem("username");
    localStorage.removeItem("api-key");
    window.location.href = "../";
}

const postLinkFromElem = (e) => `https://e621.net/posts/${e.getAttribute("data-id")}`;

/* also preloads media */
function makeElement(url, id) {
    let elem;
    if (url.endsWith(".mp4") || url.endsWith(".webm")) {
        elem = document.createElement("video");
        elem.loop = "yes";
        elem.autoplay = "yes";
        elem.muted = "yes";
    } else {
        elem = document.createElement("img");
        elem.decoding = "async";
    }

    elem.setAttribute("data-id", `${id}`);

    elem.addEventListener('click', ev => {
        window.open(postLinkFromElem(ev.srcElement), "_blank");
    });

    elem.src = url;
    return elem;
}

let lastCallTime = 0;
let queue = Promise.resolve();
async function rateLimited(promise) {
  queue = queue.then(async () => {
    const now = Date.now();
    const timeSinceLastCall = now - lastCallTime;

    const secPerCall = 1000;
    if (timeSinceLastCall < secPerCall) {
      await new Promise(resolve => setTimeout(resolve, secPerCall - timeSinceLastCall));
    }

    lastCallTime = Date.now();

    return (await promise);
  });

  return queue;
}

const media = [];

window.onload = async () => {
    const username = localStorage.getItem("username") || logout();
    const apiKey = localStorage.getItem("api-key") || logout();

    const defaultQuery = "score:>400 order:random -upvote:no";
    let query = defaultQuery;
    document.querySelector("#update-query").addEventListener("click", ev => {
        let queryValue = document.querySelector("#query").value.trim();
        query = queryValue !== "" ? queryValue : defaultQuery;

        console.log(query);
    });

    let page = 1;

    let refilling = false;

    const pageSize = 15;
    async function refillMedia() {
        if (refilling || media.length > pageSize) {
            return;
        }

        refilling = true;

        const q = encodeURIComponent(query);
        let req = await rateLimited(fetch(`https://e621.net/posts.json?_client=e6-quickview&limit=${pageSize}&tags=${q}&login=${username}&api_key=${apiKey}&page=${page}`));
        if (!req.ok) {
            alert(`could not get more posts: ${req.status}`);
        }
        let resp = await req.json();

        for (let post of resp.posts) {
            let img = ["webm", "mp4"].includes(post.file.ext) ? post.file.url : post.sample.url || post.file.url;
            media.push(makeElement(img, post.id));
        }

        refilling = false;
        page += 1;
    }

    await refillMedia();

    let mediaView = document.querySelector("#media-view");
    mediaView.appendChild(media.pop());

    const nextMedia = async (extraClass = "") => {
        const currentMedia = mediaView.firstElementChild;
        currentMedia.setAttribute("muted", "yes");
        currentMedia.remove();
        mediaView.appendChild(media.pop());
        mediaView.firstElementChild.removeAttribute("muted");

        const history = document.querySelector("#history");
        while (history.childElementCount >= 5) {
            history.lastElementChild.remove();
        }

        let mediaHistContainer = document.createElement("div");
        mediaHistContainer.classList.add(extraClass);
        mediaHistContainer.appendChild(currentMedia);
        history.prepend(mediaHistContainer);

        await refillMedia();
    };

    window.addEventListener("beforeunload", async ev => {
        const statusOrValue = await Promise.race([queue, 'pending']);
        if (statusOrValue === 'pending') {
            return "Upvotes/favourite API requests are are still queued.";
        }

        return null;
    });

    document.addEventListener("keydown", async ev => {
        if (ev.key === "ArrowLeft") { /* skip */
            await nextMedia("skipped");
        } else if (ev.key === "ArrowRight") { /* upvote */
            const postId = mediaView.firstElementChild.getAttribute("data-id");

            await nextMedia("upvoted");

            const resp = await rateLimited(fetch(
                `https://e621.net/posts/${postId}/votes.json?login=${username}&api_key=${apiKey}&_client=e6swipe`, {
                method: "POST",
                body: new URLSearchParams({ "score": 1, "no_unvote": true, }),
            }));

            if (!resp.ok) {
                alert(`Tried faving ${postId}, e6 returned ${resp.status}`);
            }
        } else if (ev.key === "ArrowUp") { /* favourite */
            const postId = mediaView.firstElementChild.getAttribute("data-id");

            await nextMedia("favourited");

            const favResp = await rateLimited(fetch(
                `https://e621.net/favorites.json?login=${username}&api_key=${apiKey}&_client=e6swipe`, {
                method: "POST",
                body: new URLSearchParams({ "post_id": postId, }),
            }));
            if (!favResp.ok) {
                alert(`Tried faving ${postId}, e6 returned ${resp.status}`);
            }

            const likeResp = await rateLimited(fetch(
                `https://e621.net/posts/${postId}/votes.json?login=${username}&api_key=${apiKey}&_client=e6swipe`, {
                method: "POST",
                body: new URLSearchParams({ "score": 1, "no_unvote": true, }),
            }));
            if (!likeResp.ok) {
                alert(`Tried liking ${postId}, e6 returned ${resp.status}`);
            }

            
        } else if (ev.key === " ") { /* open in e621 */
            await navigator.clipboard.writeText(postLinkFromElem(mediaView.firstElementChild));
        }
    });
};
    </script>
<body>
    <div id="sidebar">
        <input id="query" placeholder="score:>400 order:random -upvote:no">
        <button id="update-query">Update Search</button>

        <a target="_blank" href="../controls">Controls</a>
        <button onclick="logout()">Logout</button>

        <div id="history">
        </div>
    </div>

    <div id="media-view"></div>
</body>
</html>